<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoClickOps Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
  <div class="layout-dashboard">
    <aside>
      <div class="brand">
        <div class="brand-icon">N</div>
        <span>NoClickOps</span>
      </div>

      <div class="nav-group">
        <div class="nav-label">Platform</div>
        <a class="nav-link active" href="/dashboard.html">Dashboard</a>
        <a class="nav-link" href="/findings.html">Findings</a>
        <a class="nav-link" href="/scanners.html">Scanners</a>
        <a class="nav-link" href="/docs.html">Docs</a>
      </div>

      <div style="margin-top:auto;">
        <button id="logout-btn" class="btn btn-secondary" style="width:100%;">Logout</button>
      </div>
    </aside>

    <main>
      <div class="page-header">
        <div>
          <h1 class="page-title">Dashboard</h1>
          <p class="page-desc" id="tenant-name">Loading tenant...</p>
        </div>
        <div class="tag" id="tenant-id"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h2 style="margin:0;">Scanners</h2>
          <div style="display:flex;gap:12px;align-items:center;">
            <input id="filter-input" placeholder="Filter scanners..." style="padding:8px;border:1px solid var(--border);border-radius:4px;background:transparent;color:var(--text-main);" />
            <span class="text-muted" id="scanner-count">0 scanners</span>
            <button class="btn btn-primary" onclick="window.location.href='/scanners.html'">Add Scanner</button>
          </div>
        </div>

        <div id="scanner-list" style="display:grid;gap:12px;"></div>
      </div>

      <div class="card">
        <h2>Users</h2>
        <p class="text-muted">User management is coming soon.</p>
      </div>

      <div class="error" id="err" style="display:none;color:var(--accent-danger);margin-top:20px;"></div>
    </main>
  </div>

  <script>
    let token = localStorage.getItem("noclickops_token") || "";
    const err = document.getElementById("err");
    const tenantName = document.getElementById("tenant-name");
    const tenantId = document.getElementById("tenant-id");
    const scannerList = document.getElementById("scanner-list");
    const scannerCount = document.getElementById("scanner-count");
    const filterInput = document.getElementById("filter-input");
    const logoutBtn = document.getElementById("logout-btn");

    let allScanners = [];

    function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = "Bearer " + token;
      return fetch(path, { ...opts, headers }).then(async res => {
        const data = await res.json().catch(() => ({}));
        if (res.status === 401) {
          redirectToLogin();
          throw "unauthorized";
        }
        if (!res.ok) throw data.error || res.statusText;
        return data;
      });
    }

    function redirectToLogin() {
      localStorage.removeItem("noclickops_token");
      window.location.href = "/";
    }

    function showError(message) {
      err.style.display = "block";
      err.textContent = message;
    }

    function clearError() {
      err.style.display = "none";
    }

    async function loadMe() {
      if (!token) {
        redirectToLogin();
        return;
      }
      try {
        clearError();
        const me = await api("/v1/me");
        tenantName.textContent = me.tenant_name;
        tenantId.textContent = "ID: " + me.tenant_id;
      } catch (e) {
        showError(e);
        setTimeout(redirectToLogin, 500);
      }
    }

    async function loadScanners() {
      if (!token) return;
      try {
        clearError();
        const list = await api("/v1/scanners");
        // fetch health per scanner
        allScanners = await Promise.all(list.map(async s => {
          try {
            const h = await api(`/v1/scanners/${encodeURIComponent(s.name)}/health`);
            return { ...s, status: h.status || "unknown" };
          } catch (_) {
            return { ...s, status: "unknown" };
          }
        }));
        renderScanners();
      } catch (e) {
        showError(e);
      }
    }

    function renderScanners() {
        const term = filterInput.value.toLowerCase();
        const filtered = allScanners.filter(s => {
            if (!term) return true;
            if (s.name.toLowerCase().includes(term)) return true;
            if (String(s.id).includes(term)) return true;
            if (s.cloud_provider.toLowerCase().includes(term)) return true;
            // Check labels
            if (s.labels) {
                const labels = typeof s.labels === 'string' ? JSON.parse(s.labels) : s.labels;
                for (const [k, v] of Object.entries(labels || {})) {
                    if (k.toLowerCase().includes(term) || v.toLowerCase().includes(term)) return true;
                }
            }
            return false;
        });

        scannerCount.textContent = `${filtered.length} scanner(s)`;

        if (filtered.length === 0) {
          scannerList.innerHTML = `<div class="text-muted text-center" style="padding:20px;">No scanners found matching filter.</div>`;
          return;
        }

        scannerList.innerHTML = filtered.map(s => {
          const st = (s.status || "unknown").toLowerCase();
          const statusClass = st === "running" ? "status-green" : st === "pending" ? "status-yellow" : "status-red";
          
          let labelHtml = "";
          if (s.labels) {
              const labels = typeof s.labels === 'string' ? JSON.parse(s.labels) : s.labels;
              labelHtml = Object.entries(labels || {}).map(([k, v]) =>
                  `<span class="tag" style="font-size:0.7rem;margin-left:4px;">${k}=${v}</span>`
              ).join("");
          }

          return `
          <a href="/scanners/${encodeURIComponent(s.name)}" style="display:block;text-decoration:none;">
            <div style="background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;display:flex;justify-content:space-between;align-items:center;transition:background 0.2s;">
              <div style="display:flex;align-items:center;gap:12px;">
                <span class="status-dot ${statusClass}"></span>
                <div>
                  <div style="font-weight:600;color:var(--text-main);display:flex;align-items:center;">
                    ${s.name}
                    ${labelHtml}
                  </div>
                  <div class="text-muted" style="font-size:0.8rem;">ID: ${s.id}</div>
                </div>
              </div>
              <span class="tag">${s.cloud_provider.toUpperCase()}</span>
            </div>
          </a>
        `;
        }).join("");
    }

    filterInput.addEventListener("input", renderScanners);

    logoutBtn.addEventListener("click", redirectToLogin);

    loadMe().then(loadScanners);
  </script>
</body>

</html>
