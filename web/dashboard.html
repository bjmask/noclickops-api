<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoClickOps Dashboard</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --accent2: #7c3aed;
      --card: #0b1220;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: #e5e7eb;
      min-height: 100vh;
      display: grid;
      grid-template-columns: 280px 1fr;
    }

    aside {
      background: var(--panel);
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    main {
      padding: 24px;
      background: radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.07), transparent 25%),
        radial-gradient(circle at 80% 10%, rgba(124, 58, 237, 0.07), transparent 30%),
        var(--bg);
    }

    .brand {
      font-weight: 800;
      letter-spacing: 0.3px;
    }

    .nav-group {
      margin-top: 12px;
    }

    .nav-title {
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .nav-link {
      display: block;
      padding: 10px 12px;
      border-radius: 10px;
      color: #e5e7eb;
      text-decoration: none;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.04);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      color: #0f172a;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }

    .section {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
    }

    h2 {
      margin: 0 0 8px;
    }

    .muted {
      color: var(--muted);
    }

    .list {
      display: grid;
      gap: 10px;
    }

    .item {
      padding: 12px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .tag {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 12px;
    }

    .error {
      color: #f87171;
      font-size: 13px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: #e5e7eb;
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      text-align: left;
    }

    th {
      cursor: pointer;
      color: #cbd5e1;
    }

    .nowrap {
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <aside>
    <div class="brand">NoClickOps</div>
    <div class="nav-group">
      <div class="nav-title">Navigation</div>
      <a class="nav-link" href="#scanners">Scanners</a>
      <a class="nav-link" href="#users">Users</a>
      <a class="nav-link" href="/findings.html">Findings</a>
      <a class="nav-link" href="/docs.html">Docs</a>
      <button class="btn" id="logout-btn">Logout</button>
    </div>
  </aside>
  <main>
    <div class="section">
      <h2 id="tenant-name">Tenant</h2>
      <div class="muted" id="tenant-id"></div>
    </div>
    <div class="section" id="scanners">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2>Scanners</h2>
        <div style="display:flex;gap:10px;align-items:center;">
          <button class="btn" style="background:linear-gradient(135deg,#34d399,#10b981);"
            onclick="window.location.href='/scanners.html'">Add scanner</button>
          <span class="muted" id="scanner-count">0</span>
        </div>
      </div>
      <div class="list" id="scanner-list"></div>
    </div>
    <div class="section" id="users">
      <h2>Users</h2>
      <div class="muted">User listing not implemented yet.</div>
    </div>

    <div class="error" id="err" style="display:none;"></div>
  </main>

  <script>
    let token = localStorage.getItem("noclickops_token") || "";
    const err = document.getElementById("err");
    const tenantName = document.getElementById("tenant-name");
    const tenantId = document.getElementById("tenant-id");
    const scannerList = document.getElementById("scanner-list");
    const scannerCount = document.getElementById("scanner-count");
    const logoutBtn = document.getElementById("logout-btn");

    function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = "Bearer " + token;
      return fetch(path, { ...opts, headers }).then(async res => {
        const data = await res.json().catch(() => ({}));
        if (res.status === 401) {
          redirectToLogin();
          throw "unauthorized";
        }
        if (!res.ok) throw data.error || res.statusText;
        return data;
      });
    }

    function redirectToLogin() {
      localStorage.removeItem("noclickops_token");
      window.location.href = "/";
    }

    function showError(message) {
      err.style.display = "block";
      err.textContent = message;
    }

    function clearError() {
      err.style.display = "none";
    }

    async function loadMe() {
      if (!token) {
        redirectToLogin();
        return;
      }
      try {
        clearError();
        const me = await api("/v1/me");
        tenantName.textContent = me.tenant_name;
        tenantId.textContent = "Tenant ID: " + me.tenant_id;
      } catch (e) {
        showError(e);
        setTimeout(redirectToLogin, 500);
      }
    }





    async function loadScanners() {
      if (!token) return;
      try {
        clearError();
        const list = await api("/v1/scanners");
        // fetch health per scanner
        const withHealth = await Promise.all(list.map(async s => {
          try {
            const h = await api(`/v1/scanners/${encodeURIComponent(s.name)}/health`);
            return { ...s, status: h.status || "unknown" };
          } catch (_) {
            return { ...s, status: "unknown" };
          }
        }));
        scannerCount.textContent = withHealth.length;
        scannerList.innerHTML = withHealth.map(s => {
          const st = (s.status || "unknown").toLowerCase();
          const dotClass = st === "running" ? "dot dot-green" : st === "pending" ? "dot dot-yellow" : "dot dot-red";
          return `
          <a class="item" style="color:inherit;text-decoration:none;display:block;" href="/scanners/${encodeURIComponent(s.name)}">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong>${s.name}</strong> <span class="${dotClass}" style="width:8px;height:8px;display:inline-block;border-radius:50%;"></span><span class="muted">${st}</span></div>
              <span class="tag">${s.cloud_provider.toUpperCase()}</span>
            </div>
            <div class="muted">id: ${s.id}</div>
          </a>
        `;
        }).join("");
      } catch (e) {
        showError(e);
      }
    }

    logoutBtn.addEventListener("click", redirectToLogin);


    loadMe().then(loadScanners);
  </script>
</body>

</html>
