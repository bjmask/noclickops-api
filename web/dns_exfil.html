<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DNS Exfil Detection</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/nav.js"></script>
</head>
<body>
  <div class="layout-dashboard">
    <aside>
      <div id="nav-container"></div>
      <div style="margin-top:auto;">
        <button id="logout-btn" class="btn btn-secondary" style="width:100%;">Logout</button>
      </div>
    </aside>
    <main>
      <div class="page-header">
        <div>
          <h1 class="page-title">DNS Exfil Detection</h1>
          <p class="page-desc">DNS queries monitored for exfiltration patterns using entropy analysis.</p>
        </div>
        <div style="display:flex;gap:8px;">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="flagged-only-cb">
            <span>Flagged Only</span>
          </label>
          <button class="btn btn-secondary" id="refresh-btn">Refresh</button>
        </div>
      </div>
      <div class="card" style="padding:0;overflow:hidden;">
        <div class="table-container" style="border:none;border-radius:0;">
          <table id="dns-table" style="width:100%;table-layout:auto;">
            <thead>
              <tr>
                <th data-sort="query" data-filter="query"><div class="th-wrap"><span>Query</span><div class="th-actions"><span class="sort-icon">↕</span><span class="filter-icon">⌃</span></div></div></th>
                <th data-sort="count" data-filter="count"><div class="th-wrap"><span>Count</span><div class="th-actions"><span class="sort-icon">↕</span><span class="filter-icon">⌃</span></div></div></th>
                <th data-sort="entropy" data-filter="entropy"><div class="th-wrap"><span>Entropy</span><div class="th-actions"><span class="sort-icon">↕</span><span class="filter-icon">⌃</span></div></div></th>
                <th data-sort="flagged" data-filter="flagged"><div class="th-wrap"><span>Status</span><div class="th-actions"><span class="sort-icon">↕</span><span class="filter-icon">⌃</span></div></div></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="pagination-container" id="pagination" style="margin-top:16px;"></div>
      <div id="err" class="error" style="display:none;color:var(--accent-danger);margin-top:16px;"></div>
    </main>
  </div>
  <script>
    mountNav("dns-exfil");
    const tbody = document.querySelector("#dns-table tbody");
    const err = document.getElementById("err");
    const refreshBtn = document.getElementById("refresh-btn");
    const flaggedOnlyCb = document.getElementById("flagged-only-cb");
    const paginationContainer = document.getElementById("pagination");
    const token = localStorage.getItem("noclickops_token") || "";
    
    const FILTER_FIELDS = [
      { key: "query", label: "Query" },
      { key: "count", label: "Count" },
      { key: "entropy", label: "Entropy" },
      { key: "flagged", label: "Status" },
    ];
    
    const filterState = {};
    FILTER_FIELDS.forEach(f => {
      filterState[f.key] = { options: [], selected: new Set() };
    });
    
    let dnsQueries = [];
    let sortKey = null;
    let sortDir = 1;
    let currentPage = 1;
    let perPage = 100;
    let totalResults = 0;

    function redirectToLogin() {
      localStorage.removeItem("noclickops_token");
      window.location.href = "/";
    }

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = "Bearer " + token;
      const res = await fetch(path, { ...opts, headers });
      let data = {};
      try { data = await res.json(); } catch (_) {}
      if (res.status === 401) { redirectToLogin(); throw "unauthorized"; }
      if (!res.ok) throw data.error || res.statusText;
      return data;
    }

    function showError(msg) {
      err.textContent = msg;
      err.style.display = "block";
    }

    function clearError() { err.style.display = "none"; }

    function formatFieldValue(row, key) {
      if (key === "query") return row.query || "";
      if (key === "count") return row.count ? String(row.count) : "0";
      if (key === "entropy") return row.entropy ? row.entropy.toFixed(4) : "0.0000";
      if (key === "flagged") return row.flagged ? "⚠️ High Entropy" : "Normal";
      return "";
    }

    function applyFilters(rows) {
      return rows.filter(r => {
        for (const field of FILTER_FIELDS) {
          const fState = filterState[field.key];
          if (fState.selected.size > 0) {
            const val = formatFieldValue(r, field.key);
            if (!fState.selected.has(val)) return false;
          }
        }
        return true;
      });
    }

    function applySorting(rows) {
      if (!sortKey) return rows;
      const sorted = [...rows];
      sorted.sort((a, b) => {
        let aVal = a[sortKey];
        let bVal = b[sortKey];
        if (sortKey === "query") {
          aVal = (aVal || "").toLowerCase();
          bVal = (bVal || "").toLowerCase();
          return sortDir * aVal.localeCompare(bVal);
        }
        if (sortKey === "flagged") {
          aVal = a.flagged ? 1 : 0;
          bVal = b.flagged ? 1 : 0;
          return sortDir * (aVal - bVal);
        }
        if (typeof aVal === "number" && typeof bVal === "number") {
          return sortDir * (aVal - bVal);
        }
        return 0;
      });
      return sorted;
    }

    function renderTable() {
      let filtered = applyFilters(dnsQueries);
      filtered = applySorting(filtered);
      
      tbody.innerHTML = "";
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No DNS queries found</td></tr>';
        return;
      }
      
      filtered.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "table-row";
        if (row.flagged) {
          tr.classList.add("row-danger");
        }
        
        const tdQuery = document.createElement("td");
        tdQuery.textContent = row.query;
        tdQuery.style.fontFamily = "monospace";
        tdQuery.style.wordBreak = "break-all";
        tr.appendChild(tdQuery);
        
        const tdCount = document.createElement("td");
        tdCount.textContent = row.count || 0;
        tr.appendChild(tdCount);
        
        const tdEntropy = document.createElement("td");
        tdEntropy.textContent = row.entropy ? row.entropy.toFixed(4) : "0.0000";
        tr.appendChild(tdEntropy);
        
        const tdStatus = document.createElement("td");
        if (row.flagged) {
          tdStatus.innerHTML = '<span style="color:var(--accent-danger);font-weight:600;">⚠️ High Entropy</span>';
        } else {
          tdStatus.textContent = "Normal";
        }
        tr.appendChild(tdStatus);
        
        tbody.appendChild(tr);
      });
    }

    function buildFilterOptions() {
      FILTER_FIELDS.forEach(field => {
        const uniqueVals = new Set();
        dnsQueries.forEach(row => {
          const val = formatFieldValue(row, field.key);
          if (val) uniqueVals.add(val);
        });
        filterState[field.key].options = Array.from(uniqueVals).sort();
      });
    }

    function showFilterDropdown(th, field) {
      closeAllDropdowns();
      const dropdown = document.createElement("div");
      dropdown.className = "filter-dropdown";
      dropdown.style.position = "absolute";
      dropdown.style.top = (th.getBoundingClientRect().bottom + window.scrollY) + "px";
      dropdown.style.left = th.getBoundingClientRect().left + "px";
      dropdown.style.background = "var(--bg-elevated)";
      dropdown.style.border = "1px solid var(--border-subtle)";
      dropdown.style.borderRadius = "var(--radius)";
      dropdown.style.padding = "8px";
      dropdown.style.zIndex = "10000";
      dropdown.style.boxShadow = "var(--shadow-md)";
      dropdown.style.minWidth = "200px";
      dropdown.style.maxHeight = "400px";
      dropdown.style.overflowY = "auto";

      const searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.placeholder = `Search ${field.label}...`;
      searchInput.style.width = "100%";
      searchInput.style.marginBottom = "8px";
      searchInput.style.padding = "4px 8px";
      searchInput.style.border = "1px solid var(--border-subtle)";
      searchInput.style.borderRadius = "var(--radius)";
      dropdown.appendChild(searchInput);

      const optionsDiv = document.createElement("div");
      optionsDiv.style.display = "flex";
      optionsDiv.style.flexDirection = "column";
      optionsDiv.style.gap = "4px";

      const renderOptions = (searchTerm = "") => {
        optionsDiv.innerHTML = "";
        const regex = searchTerm ? new RegExp(searchTerm, "i") : null;
        const filtered = filterState[field.key].options.filter(opt => 
          !regex || regex.test(opt)
        );

        filtered.forEach((opt, idx) => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.gap = "8px";
          label.style.cursor = "pointer";
          label.style.padding = "4px";
          label.style.borderRadius = "var(--radius)";
          label.dataset.index = idx;

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = filterState[field.key].selected.has(opt);
          checkbox.onchange = () => {
            if (checkbox.checked) {
              filterState[field.key].selected.add(opt);
            } else {
              filterState[field.key].selected.delete(opt);
            }
          };
          label.appendChild(checkbox);

          const span = document.createElement("span");
          span.textContent = opt;
          label.appendChild(span);

          optionsDiv.appendChild(label);
        });
      };

      renderOptions();
      dropdown.appendChild(optionsDiv);

      searchInput.oninput = (e) => {
        renderOptions(e.target.value);
      };

      const btnDiv = document.createElement("div");
      btnDiv.style.marginTop = "8px";
      btnDiv.style.display = "flex";
      btnDiv.style.gap = "8px";

      const applyBtn = document.createElement("button");
      applyBtn.textContent = "Apply";
      applyBtn.className = "btn btn-primary";
      applyBtn.style.fontSize = "12px";
      applyBtn.style.padding = "4px 8px";
      applyBtn.onclick = () => {
        renderTable();
        closeAllDropdowns();
      };
      btnDiv.appendChild(applyBtn);

      const clearBtn = document.createElement("button");
      clearBtn.textContent = "Clear";
      clearBtn.className = "btn btn-secondary";
      clearBtn.style.fontSize = "12px";
      clearBtn.style.padding = "4px 8px";
      clearBtn.onclick = () => {
        filterState[field.key].selected.clear();
        renderOptions();
      };
      btnDiv.appendChild(clearBtn);

      dropdown.appendChild(btnDiv);
      document.body.appendChild(dropdown);

      let selectedIndex = -1;
      const updateSelection = () => {
        const labels = optionsDiv.querySelectorAll("label");
        labels.forEach((lbl, idx) => {
          if (idx === selectedIndex) {
            lbl.style.backgroundColor = "var(--accent-primary-alpha)";
          } else {
            lbl.style.backgroundColor = "";
          }
        });
      };

      searchInput.onkeydown = (e) => {
        const labels = optionsDiv.querySelectorAll("label");
        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, labels.length - 1);
          updateSelection();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, 0);
          updateSelection();
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (selectedIndex >= 0 && selectedIndex < labels.length) {
            const checkbox = labels[selectedIndex].querySelector("input[type=checkbox]");
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event("change"));
          }
        } else if ((e.metaKey || e.ctrlKey) && e.key === " ") {
          e.preventDefault();
          renderTable();
          closeAllDropdowns();
        }
      };

      setTimeout(() => searchInput.focus(), 0);

      function closeOnClickOutside(e) {
        if (!dropdown.contains(e.target) && !th.contains(e.target)) {
          closeAllDropdowns();
        }
      }
      document.addEventListener("click", closeOnClickOutside);
      dropdown._cleanup = () => document.removeEventListener("click", closeOnClickOutside);
    }

    function closeAllDropdowns() {
      document.querySelectorAll(".filter-dropdown").forEach(d => {
        if (d._cleanup) d._cleanup();
        d.remove();
      });
    }

    function setupTableHeaders() {
      const ths = document.querySelectorAll("#dns-table th");
      ths.forEach(th => {
        const sortK = th.dataset.sort;
        const filterKey = th.dataset.filter;

        const sortIcon = th.querySelector(".sort-icon");
        if (sortIcon && sortK) {
          sortIcon.style.cursor = "pointer";
          sortIcon.onclick = (e) => {
            e.stopPropagation();
            if (sortKey === sortK) sortDir *= -1;
            else { sortKey = sortK; sortDir = 1; }
            renderTable();
            updateSortIcons();
          };
        }

        const filterIcon = th.querySelector(".filter-icon");
        if (filterIcon && filterKey) {
          filterIcon.style.cursor = "pointer";
          filterIcon.onclick = (e) => {
            e.stopPropagation();
            const field = FILTER_FIELDS.find(f => f.key === filterKey);
            if (field) showFilterDropdown(th, field);
          };
        }
      });
    }

    function updateSortIcons() {
      document.querySelectorAll("#dns-table th .sort-icon").forEach(icon => {
        const th = icon.closest("th");
        const key = th?.dataset.sort;
        if (key === sortKey) {
          icon.textContent = sortDir > 0 ? "↓" : "↑";
        } else {
          icon.textContent = "↕";
        }
      });
    }

    function renderPagination() {
      paginationContainer.innerHTML = "";
      const totalPages = Math.ceil(totalResults / perPage);
      if (totalPages <= 1) return;

      const div = document.createElement("div");
      div.style.display = "flex";
      div.style.gap = "8px";
      div.style.alignItems = "center";
      div.style.justifyContent = "center";

      const prevBtn = document.createElement("button");
      prevBtn.textContent = "Previous";
      prevBtn.className = "btn btn-secondary";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          loadData();
        }
      };
      div.appendChild(prevBtn);

      const pageInfo = document.createElement("span");
      pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalResults} total)`;
      div.appendChild(pageInfo);

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "Next";
      nextBtn.className = "btn btn-secondary";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          loadData();
        }
      };
      div.appendChild(nextBtn);

      paginationContainer.appendChild(div);
    }

    async function loadData() {
      clearError();
      refreshBtn.disabled = true;
      refreshBtn.textContent = "Loading...";
      
      try {
        const params = new URLSearchParams({
          page: currentPage.toString(),
          per_page: perPage.toString(),
        });
        
        if (flaggedOnlyCb.checked) {
          params.append("flagged_only", "true");
        }
        
        const data = await api(`/v1/network/dns?${params}`);
        dnsQueries = data.queries || [];
        totalResults = data.total || 0;
        
        buildFilterOptions();
        renderTable();
        renderPagination();
      } catch (e) {
        showError("Failed to load DNS queries: " + String(e));
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = "Refresh";
      }
    }

    refreshBtn.addEventListener("click", () => {
      currentPage = 1;
      loadData();
    });
    
    flaggedOnlyCb.addEventListener("change", () => {
      currentPage = 1;
      loadData();
    });

    setupTableHeaders();
    loadData();

    document.getElementById("logout-btn").addEventListener("click", () => {
      localStorage.removeItem("noclickops_token");
      window.location.href = "/";
    });
  </script>
</body>
</html>
