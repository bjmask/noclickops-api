<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Detail</title>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    body { margin:0; font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#0f172a; color:#e5e7eb; padding:24px; }
    .card { max-width: 900px; margin: 0 auto; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05); border-radius:14px; padding:16px; }
    .muted { color:#9ca3af; }
    .tag { display:inline-flex; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.1); font-size:12px; }
    .error { color:#f87171; }
    pre, textarea { background:#0b1220; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); overflow:auto; color:#e5e7eb; width:100%; box-sizing:border-box; }
    textarea { min-height: 220px; }
    input { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); background:#0f172a; color:#e5e7eb; }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; color:#0f172a; background:linear-gradient(135deg,#22d3ee,#7c3aed); }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; }
    .dot-green { background:#34d399; }
    .dot-yellow { background:#fbbf24; }
    .dot-red { background:#f87171; }
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Scanner</h2>
    <div class="muted"><span id="status-dot" class="dot dot-yellow"></span><span id="status">Loading...</span></div>
    <div id="err" class="error" style="display:none;"></div>

    <h3>Config (editable YAML)</h3>
    <textarea id="config-text" placeholder="Scanner config YAML"></textarea>
    <label>Region</label>
    <input id="region" placeholder="us-west-2" />
    <label>JIRA_EMAIL</label>
    <input id="jira-email" placeholder="user@example.com" />

    <h3>Credentials (optional)</h3>
    <label>AWS_ACCESS_KEY_ID</label>
    <input id="aws-ak" placeholder="leave blank to keep existing" />
    <label>AWS_SECRET_ACCESS_KEY</label>
    <input id="aws-sk" placeholder="leave blank to keep existing" />
    <label>AWS_SESSION_TOKEN</label>
    <input id="aws-st" placeholder="leave blank to keep existing" />
    <label>JIRA_TOKEN</label>
    <input id="jira-token" placeholder="leave blank to keep existing" />

    <div class="actions">
      <button class="btn" onclick="updateScanner()" style="background:linear-gradient(135deg,#34d399,#10b981);">Save changes</button>
      <button class="btn" onclick="window.location.href='/dashboard.html'">Back to dashboard</button>
      <button class="btn" id="follow-logs" style="background:linear-gradient(135deg,#22d3ee,#0ea5e9);">Follow logs</button>
      <button class="btn" id="delete-btn" style="background:linear-gradient(135deg,#f87171,#ef4444);">Delete scanner</button>
    </div>
    <h3>Logs</h3>
    <textarea id="log-box" readonly style="min-height:180px;"></textarea>
  </div>

  <script>
    const token = localStorage.getItem("noclickops_token") || "";
    const name = decodeURIComponent(window.location.pathname.split("/").pop());
    const statusEl = document.getElementById("status");
    const statusDot = document.getElementById("status-dot");
    const configText = document.getElementById("config-text");
    const errEl = document.getElementById("err");
    const logBox = document.getElementById("log-box");
    const followBtn = document.getElementById("follow-logs");
    let logController = null;
    let statusInterval = null;
    document.getElementById("title").textContent = `Scanner: ${name}`;

    function redirectToLogin() {
      localStorage.removeItem("noclickops_token");
      window.location.href = "/";
    }

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = "Bearer " + token;
      const res = await fetch(path, { ...opts, headers });
      const data = await res.json().catch(() => ({}));
      if (res.status === 401) { redirectToLogin(); throw "unauthorized"; }
      if (!res.ok) throw data.error || res.statusText;
      return data;
    }

    async function load() {
      try {
        await loadHealth();
        const scanner = await api(`/v1/scanners/${encodeURIComponent(name)}`);
        if (scanner.config_json) {
          configText.value = JSON.stringify(scanner.config_json, null, 2);
          // try to present YAML if available
          try {
            configText.value = jsyaml.dump(scanner.config_json);
          } catch (_) {}
        } else {
          configText.value = "";
        }
        if (scanner.config_json && scanner.config_json.region) {
          document.getElementById("region").value = scanner.config_json.region || "";
        }
        if (scanner.config_json && scanner.config_json.jira && scanner.config_json.jira.email) {
          document.getElementById("jira-email").value = scanner.config_json.jira.email || "";
        }
      } catch (e) {
        errEl.style.display = "block";
        errEl.textContent = e;
      }
    }

    async function loadHealth() {
      try {
        const health = await api(`/v1/scanners/${encodeURIComponent(name)}/health`);
        const st = (health.status || 'unknown').toLowerCase();
        statusEl.textContent = `Status: ${st}`;
        statusDot.className = "dot " + (st === "running" ? "dot-green" : st === "pending" ? "dot-yellow" : "dot-red");
      } catch (e) {
        statusEl.textContent = `Status: error`;
        statusDot.className = "dot dot-red";
      }
    }

    function startStatusPoll() {
      stopStatusPoll();
      statusInterval = setInterval(loadHealth, 5000);
    }

    function stopStatusPoll() {
      if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
      }
    }

    async function streamLogs() {
      if (logController) {
        logController.abort();
        logController = null;
        followBtn.textContent = "Follow logs";
        return;
      }
      logController = new AbortController();
      followBtn.textContent = "Stop";
      logBox.value = "";
      try {
        const res = await fetch(`/v1/scanners/${encodeURIComponent(name)}/logs`, {
          headers: token ? { "Authorization": "Bearer " + token } : {},
          signal: logController.signal
        });
        if (res.status === 401) { redirectToLogin(); return; }
        if (!res.ok || !res.body) throw await res.text();
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          logBox.value += decoder.decode(value);
          logBox.scrollTop = logBox.scrollHeight;
        }
      } catch (e) {
        if (e.name !== "AbortError") {
          errEl.style.display = "block";
          errEl.textContent = e;
        }
      } finally {
        if (logController) {
          logController = null;
          followBtn.textContent = "Follow logs";
        }
      }
    }

    async function updateScanner() {
      try {
        errEl.style.display = "none";
        let cfg = {};
        if (configText.value.trim()) {
          try {
            cfg = jsyaml.load(configText.value);
          } catch (e) {
            cfg = JSON.parse(configText.value);
          }
        }
        const cfgRegion = document.getElementById("region").value.trim();
        const body = {
          config: cfg,
          region: cfgRegion || undefined,
          aws_access_key_id: document.getElementById("aws-ak").value.trim() || undefined,
          aws_secret_access_key: document.getElementById("aws-sk").value.trim() || undefined,
          aws_session_token: document.getElementById("aws-st").value.trim() || undefined,
          jira_token: document.getElementById("jira-token").value.trim() || undefined,
          jira_email: document.getElementById("jira-email").value.trim() || undefined,
        };
        await api(`/v1/scanners/${encodeURIComponent(name)}`, {
          method: "PUT",
          body: JSON.stringify(body),
        });
        statusEl.textContent = "Updated; reconciling deployment...";
        startStatusPoll();
      } catch (e) {
        errEl.style.display = "block";
        errEl.textContent = e;
      }
    }

    followBtn.addEventListener("click", streamLogs);
    document.getElementById("delete-btn").addEventListener("click", async () => {
      if (!confirm("Delete this scanner?")) return;
      try {
        await api(`/v1/scanners/${encodeURIComponent(name)}`, { method: "DELETE" });
        window.location.href = "/dashboard.html";
      } catch (e) {
        errEl.style.display = "block";
        errEl.textContent = e;
      }
    });
    if (!token) redirectToLogin(); else load();
  </script>
</body>
</html>
