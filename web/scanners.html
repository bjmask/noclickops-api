<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoClickOps Scanners</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .masked-input {
      -webkit-text-security: disc;
      text-security: disc;
    }
  </style>
</head>

<body>
  <div class="layout-dashboard">
    <aside>
      <div class="brand">
        <div class="brand-icon">N</div>
        <span>NoClickOps</span>
      </div>

      <div class="nav-group">
        <div class="nav-label">Platform</div>
        <a class="nav-link" href="/dashboard.html">Dashboard</a>
        <a class="nav-link" href="/findings.html">Findings</a>
        <a class="nav-link active" href="/scanners.html">Scanners</a>
        <a class="nav-link" href="/docs.html">Docs</a>
      </div>

      <div style="margin-top:auto;">
        <button id="logout-btn" class="btn btn-secondary" style="width:100%;">Logout</button>
      </div>
    </aside>

    <main>
      <div class="page-header">
        <div>
          <h1 class="page-title">Scanners</h1>
          <p class="page-desc">Manage your infrastructure scanners.</p>
        </div>
        <div>
          <button class="btn btn-primary" id="open-create-btn">Create Scanner</button>
        </div>
      </div>

      <div id="scanners-list" style="display:grid;gap:16px;margin-bottom:32px;">
        <!-- Scanners will be loaded here -->
        <div style="color:var(--text-muted);">Loading scanners...</div>
      </div>

      <div id="create-form" style="display:none;">
        <div class="page-header">
          <div>
            <h2 class="page-title" style="font-size:1.5rem;">New Scanner Config</h2>
          </div>
          <div style="display:flex;gap:12px;">
            <button class="btn btn-secondary" id="cancel-create-btn">Cancel</button>
            <button class="btn btn-secondary" id="preview">Preview Config</button>
            <button class="btn btn-primary" id="create-btn">Save Scanner</button>
          </div>
        </div>

        <div class="error" id="err" style="display:none;margin-bottom:24px;"></div>

        <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;">
        <div>
          <div class="card">
            <h3 style="margin-bottom:20px;">General Configuration</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="input-group">
                <label class="input-label">Scanner Name</label>
                <input id="sc-name" placeholder="my-scanner" />
              </div>
              <div class="input-group">
                <label class="input-label">Cloud Provider</label>
                <select id="cloud-provider">
                  <option value="aws">AWS</option>
                  <option value="gcp">GCP</option>
                  <option value="azure">Azure</option>
                </select>
              </div>
              <div class="input-group">
                <label class="input-label">Scanner Type</label>
                <select id="scanner-type">
                  <option value="iam">IAM (CloudTrail/Kinesis)</option>
                  <option value="kube-audit">Kube Audit</option>
                </select>
              </div>
              <div class="input-group">
                <label class="input-label">Region</label>
                <input id="region" placeholder="us-west-2" />
              </div>
              <div class="input-group">
                <label class="input-label">Labels (key=value)</label>
                <textarea id="labels" rows="3" placeholder="env=prod&#10;team=platform"></textarea>
              </div>
            </div>
  
            <div class="iam-only" style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="input-group">
                <label class="input-label">Source</label>
                <select id="source">
                  <option value="cloudtrail">cloudtrail</option>
                  <option value="kinesis">kinesis</option>
                </select>
              </div>
              <div class="input-group">
                <label class="input-label">Kinesis Stream (if kinesis)</label>
                <input id="kinesis-stream" placeholder="stream-name" />
              </div>
              <div class="input-group">
                <label class="input-label">AWS Account ID (optional)</label>
                <input id="aws-account" placeholder="123456789012" />
              </div>
            </div>

            <div class="kube-only" style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="input-group">
                <label class="input-label">Audit Log Group</label>
                <input id="kube-log-group" placeholder="/aws/eks/cluster/audit" />
              </div>
              <div class="input-group">
                <label class="input-label">Audit Stream Prefix</label>
                <input id="kube-log-prefix" placeholder="kube-apiserver-audit" />
              </div>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:20px;">Detection Rules</h3>

            <div class="iam-detection">
              <div class="input-group">
                <label class="input-label">Console user agents (newline separated)</label>
                <textarea id="console-uas" rows="4"></textarea>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                <div class="input-group">
                  <label class="input-label">Terraform user agents</label>
                  <textarea id="tf-uas" rows="4"></textarea>
                </div>
                <div class="input-group">
                  <label class="input-label">Terraform role hints</label>
                  <textarea id="tf-roles" rows="4"></textarea>
                </div>
              </div>
            </div>

            <div class="kube-only">
              <div class="input-group">
                <label class="input-label">Kube verbs</label>
                <textarea id="kube-verbs" rows="4" placeholder="create\nupdate..."></textarea>
              </div>
              <div class="input-group">
                <label class="input-label">Kube ignore users (glob)</label>
                <textarea id="kube-ignore-users" rows="4" placeholder="system:node:*"></textarea>
              </div>
            </div>

            <h4 style="margin-top:24px;margin-bottom:16px;color:var(--text-muted);">Filters</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="input-group iam-only">
                <label class="input-label">Ignore actors</label>
                <textarea id="ignore-actors" rows="4"></textarea>
              </div>
              <div class="input-group">
                <label class="input-label">Ignore user agents</label>
                <textarea id="ignore-uas" rows="4"></textarea>
              </div>
              <div class="input-group">
                <label class="input-label">Allowed events</label>
                <textarea id="whitelist-events" rows="4"></textarea>
              </div>
              <div class="input-group">
                <label class="input-label">Disallowed events</label>
                <textarea id="blacklist-events" rows="4"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <h3 style="margin-bottom:20px;">Settings</h3>
            <div class="input-group">
              <label class="input-label">Lookback minutes</label>
              <input id="lookback-minutes" type="number" min="0" placeholder="e.g. 15" />
            </div>
            <div class="input-group">
              <label class="input-label">Lookback hours</label>
              <input id="lookback-hours" type="number" min="0" placeholder="e.g. 1" />
            </div>
            <div class="input-group">
              <label class="input-label">Poll interval (ms)</label>
              <input id="poll-ms" type="number" min="50" step="50" placeholder="1000" />
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:20px;">Jira Integration</h3>
            <div class="input-group">
              <label class="input-label">Base URL</label>
              <input id="jira-url" placeholder="https://example.atlassian.net" />
            </div>
            <div class="input-group">
              <label class="input-label">Project Key</label>
              <input id="jira-project" placeholder="OPS" />
            </div>
            <div class="input-group">
              <label class="input-label">Issue Type</label>
              <input id="jira-issue" placeholder="Task" />
            </div>
            <div class="input-group">
              <label class="input-label">JIRA_EMAIL</label>
              <input id="jira-email" placeholder="user@example.com" />
            </div>
            <div class="input-group">
              <label class="input-label">JIRA_TOKEN</label>
              <input id="jira-token" autocomplete="off" type="password" placeholder="leave blank to omit" />
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:20px;">Credentials</h3>
            <!-- Anti-autofill trap -->
            <div style="height:0;overflow:hidden;">
              <input type="text" name="fake_user_trap" tabindex="-1" />
              <input type="password" name="fake_pass_trap" tabindex="-1" />
            </div>

            <form autocomplete="off" onsubmit="return false;">
              <div class="input-group">
                <label class="input-label">AWS_ACCESS_KEY_ID</label>
                <input id="aws-ak" name="noclickops_ak_field" placeholder="optional" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')" style="background-color:inherit;" />
              </div>
              <div class="input-group">
                <label class="input-label">AWS_SECRET_ACCESS_KEY</label>
                <input id="aws-ak" name="noclickops_ak_field" placeholder="optional" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')" style="background-color:inherit;" />
              </div>
              <div class="input-group">
                <label class="input-label">AWS_SESSION_TOKEN</label>
                <textarea id="aws-st" name="noclickops_st_field" placeholder="optional" class="masked-input" rows="1" style="resize:none; overflow:hidden; white-space:nowrap; padding-top:10px;"></textarea>
              </div>
            </form>
          </div>
        </div>
      </div>

        <div class="card" style="margin-top:24px;">
          <h3>Preview Output</h3>
          <pre id="output" class="terminal" style="min-height:200px;"></pre>
        </div>
      </div>
    </main>
  </div>

  <script>
    const output = document.getElementById("output");
    const err = document.getElementById("err");
    const logoutBtn = document.getElementById("logout-btn");
    const token = localStorage.getItem("noclickops_token") || "";
    const listEl = document.getElementById("scanners-list");
    const formEl = document.getElementById("create-form");
    
    applyDefaults();
    loadScanners();

    document.getElementById("open-create-btn").addEventListener("click", () => {
      formEl.style.display = "block";
      document.getElementById("open-create-btn").style.display = "none";
      document.getElementById("scanners-list").style.display = "none";
    });

    document.getElementById("cancel-create-btn").addEventListener("click", () => {
      formEl.style.display = "none";
      document.getElementById("open-create-btn").style.display = "block";
      document.getElementById("scanners-list").style.display = "grid";
    });

    async function loadScanners() {
      try {
        const list = await api("/v1/scanners");
        if (!Array.isArray(list)) {
          listEl.innerHTML = '<div style="color:red">Failed to load scanners</div>';
          return;
        }
        if (list.length === 0) {
          listEl.innerHTML = '<div style="color:var(--text-muted)">No scanners found. Create one to get started.</div>';
          return;
        }

        // fetch health per scanner
        const scanners = await Promise.all(list.map(async s => {
          try {
            const h = await api(`/v1/scanners/${encodeURIComponent(s.name)}/health`);
            return { ...s, status: h.status || "unknown" };
          } catch (_) {
            return { ...s, status: "unknown" };
          }
        }));

        listEl.innerHTML = scanners.map(s => {
          const st = (s.status || "unknown").toLowerCase();
          const statusClass = st === "running" ? "status-green" : st === "pending" ? "status-yellow" : "status-red";
          return `
          <div class="card" style="display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;align-items:center;gap:12px;">
              <span class="status-dot ${statusClass}" title="${st}"></span>
              <div>
                <div style="font-weight:600;font-size:1.1rem;margin-bottom:4px;">
                  <a href="/scanners/${s.name}" style="color:inherit;text-decoration:none;border-bottom:1px solid var(--primary);">${s.name}</a>
                </div>
                <div style="font-size:0.9rem;color:var(--text-muted);">
                  ${s.cloud_provider.toUpperCase()} &bull; Created ${new Date(s.created_at).toLocaleDateString()}
                </div>
              </div>
            </div>
            <a href="/scanners/${s.name}" class="btn btn-secondary" style="font-size:0.9rem;">View Details</a>
          </div>
        `;
        }).join("");
      } catch (e) {
        listEl.innerHTML = `<div style="color:red">Error: ${e}</div>`;
      }
    }

    function toggleFields() {
      const type = document.getElementById("scanner-type").value;
      document.querySelectorAll(".iam-only").forEach(el => {
        el.style.display = type === "iam" ? "grid" : "none";
      });
      document.querySelectorAll(".kube-only").forEach(el => {
        el.style.display = type === "kube-audit" ? "grid" : "none";
      });
      document.querySelectorAll(".iam-detection").forEach(el => {
        el.style.display = type === "iam" ? "block" : "none";
      });
    }
    document.getElementById("scanner-type").addEventListener("change", toggleFields);
    toggleFields();

    function parseLines(id) {
      return document.getElementById(id).value
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);
    }

    document.getElementById("preview").addEventListener("click", () => {
      err.style.display = "none";
      const scannerPayload = buildPayload();
      output.textContent = JSON.stringify(scannerPayload, null, 2);
    });

    function emptyToNull(v) { return v === "" ? null : v; }

    function buildPayload() {
      const labelsRaw = parseLines("labels");
      const labels = {};
      labelsRaw.forEach(line => {
        const parts = line.split("=");
        if (parts.length >= 2) {
          labels[parts[0].trim()] = parts.slice(1).join("=").trim();
        }
      });

      const cfg = {
        detection: {
          console_user_agents: parseLines("console-uas"),
          terraform_user_agents: parseLines("tf-uas"),
          terraform_role_hints: parseLines("tf-roles"),
        },
        ignore_actors: parseLines("ignore-actors"),
        ignore_user_agents: parseLines("ignore-uas"),
        whitelist_events: parseLines("whitelist-events"),
        blacklist_events: parseLines("blacklist-events"),
        jira: {
          base_url: emptyToNull(document.getElementById("jira-url").value.trim()),
          project_key: emptyToNull(document.getElementById("jira-project").value.trim()),
          issue_type: emptyToNull(document.getElementById("jira-issue").value.trim()),
          email: emptyToNull(document.getElementById("jira-email").value.trim()),
        },
      };

      const scannerType = document.getElementById("scanner-type").value;
      const region = emptyToNull(document.getElementById("region").value.trim());
      const lookbackMinutes = parseInt(document.getElementById("lookback-minutes").value, 10);
      const lookbackHours = parseInt(document.getElementById("lookback-hours").value, 10);
      const pollMs = parseInt(document.getElementById("poll-ms").value, 10);
      if (!isNaN(lookbackMinutes)) cfg.lookback_minutes = lookbackMinutes;
      if (!isNaN(lookbackHours)) cfg.lookback_hours = lookbackHours;
      if (!isNaN(pollMs)) cfg.poll_milliseconds = pollMs;

      if (scannerType === "iam") {
        cfg.source = document.getElementById("source").value;
        cfg.region = region;
        cfg.kinesis_stream = emptyToNull(document.getElementById("kinesis-stream").value.trim());
        cfg.aws = {
          region,
          account_id: emptyToNull((document.getElementById("aws-account") || {}).value?.trim() || ""),
          poll_milliseconds: cfg.poll_milliseconds,
          lookback_minutes: cfg.lookback_minutes,
          lookback_hours: cfg.lookback_hours,
        };
      } else {
        cfg.source = "kubernetes-cloudwatch";
        const kubeVerbs = parseLines("kube-verbs");
        const kubeIgnore = parseLines("kube-ignore-users");
        cfg.kubernetes = {
          region,
          cloudwatch_log_group: emptyToNull(document.getElementById("kube-log-group").value.trim()),
          cloudwatch_log_stream_prefix: emptyToNull(document.getElementById("kube-log-prefix").value.trim()),
          kube_verbs: kubeVerbs,
          kube_ignore_users: kubeIgnore,
          poll_milliseconds: cfg.poll_milliseconds,
          lookback_minutes: cfg.lookback_minutes,
          lookback_hours: cfg.lookback_hours,
        };
      }

      return {
        name: document.getElementById("sc-name").value.trim(),
        cloud_provider: document.getElementById("cloud-provider").value,
        config: cfg,
        labels: labels,
        aws_access_key_id: emptyToNull((document.getElementById("aws-ak") || {}).value?.trim() || "") || undefined,
        aws_secret_access_key: emptyToNull((document.getElementById("aws-sk") || {}).value?.trim() || "") || undefined,
        aws_session_token: emptyToNull((document.getElementById("aws-st") || {}).value?.trim() || "") || undefined,
        jira_token: emptyToNull((document.getElementById("jira-token") || {}).value?.trim() || "") || undefined,
      };
    }

    function redirectToLogin() {
      localStorage.removeItem("noclickops_token");
      window.location.href = "/";
    }

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = "Bearer " + token;
      const res = await fetch(path, { ...opts, headers });
      const data = await res.json().catch(() => ({}));
      if (res.status === 401) {
        redirectToLogin();
        throw "unauthorized";
      }
      if (!res.ok) throw data.error || res.statusText;
      return data;
    }

    async function createScanner() {
      try {
        const payload = buildPayload();
        if (!payload.name) {
          err.style.display = "block";
          err.textContent = "Scanner name is required";
          return;
        }
        err.style.display = "none";
        output.textContent = "Submitting...";
        const res = await api("/v1/scanners", {
          method: "POST",
          body: JSON.stringify(payload),
        });
        output.textContent = "Created scanner:\n" + JSON.stringify(res, null, 2);
        // Redirect to dashboard after short delay
        setTimeout(() => window.location.href = "/dashboard.html", 1500);
      } catch (e) {
        err.style.display = "block";
        err.textContent = e;
      }
    }

    document.getElementById("create-btn").addEventListener("click", createScanner);
    logoutBtn.addEventListener("click", redirectToLogin);

    if (!token) redirectToLogin();

    function applyDefaults() {
      document.getElementById("source").value = "cloudtrail";
      document.getElementById("cloud-provider").value = "aws";
      document.getElementById("region").value = "";
      document.getElementById("kube-log-prefix").value = "kube-apiserver-audit";
      document.getElementById("kube-verbs").value = [
        "create", "update", "patch", "delete", "deletecollection", "exec", "port-forward", "portforward", "cp"
      ].join("\n");
      document.getElementById("console-uas").value = [
        "console.amazonaws.com",
        "signin.amazonaws.com",
        "*mozilla*",
        "*chrome*",
        "*safari*",
        "*firefox*",
        "*edge*"
      ].join("\n");
      document.getElementById("tf-uas").value = ["terraform", "tfc-agent"].join("\n");
      document.getElementById("tf-roles").value = ["terraform", "tf-controller"].join("\n");
      document.getElementById("ignore-actors").value = [
        "aws-reserved/sso.amazonaws.com",
        "AWSServiceRoleForAmazonEKS*",
        "arn:aws:sts::*:assumed-role/test-us-west-2-singleton-management/*",
        "arn:aws:sts::*:assumed-role/AWSServiceRole*",
        "arn:aws:sts::*:assumed-role/PrismaCloudOrgRole*",
        "arn:aws:sts::*:assumed-role/*pecan*",
        "arn:aws:sts::*:assumed-role/*pistachio*"
      ].join("\n");
      document.getElementById("ignore-uas").value = [
        "aws-sdk-go*",
        "eks.amazonaws.com",
        "autoscaling.amazonaws.com",
        "arn:aws:sts::015096527731:assumed-role/PrismaCloudOrgRole*",
        "arn:aws:sts::015096527731:assumed-role/*node-group*",
        "aws-sdk-rust/1.3.10",
        "securityhub.amazonaws.com"
      ].join("\n");
      document.getElementById("whitelist-events").value = [
        "Create*", "Put*", "Update*", "Delete*", "Attach*", "Detach*", "Enable*", "Disable*", "Set*",
        "Associate*", "Disassociate*", "Register*", "Deregister*", "Tag*", "Untag*", "Start*", "Stop*",
        "RunInstances", "Launch*", "Allocate*", "Release*", "Authorize*", "Revoke*", "Add*", "Remove*",
        "Import*", "Export*", "Copy*", "Move*", "Apply*", "Submit*", "Cancel*", "Execute*", "Provision*",
        "Deprovision*", "Deploy*", "Invoke*", "Restart*", "Reboot*", "Suspend*", "Resume*", "Publish*",
        "Unpublish*", "Rotate*"
      ].join("\n");
      document.getElementById("blacklist-events").value = ["PutObject", "AssumeRole"].join("\n");
      document.getElementById("jira-url").value = "https://adecastro.atlassian.net";
      document.getElementById("jira-project").value = "NOCLICKOPS";
      document.getElementById("jira-issue").value = "Initiative";
    }
  </script>
</body>

</html>
