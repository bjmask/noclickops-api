<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoClickOps Findings</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --accent2: #7c3aed;
      --card: #0b1220;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: #e5e7eb;
      min-height: 100vh;
      display: grid;
      grid-template-columns: 280px 1fr;
    }
    aside {
      background: var(--panel);
      border-right: 1px solid rgba(255,255,255,0.05);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    main {
      padding: 24px;
      background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.07), transparent 25%),
                  radial-gradient(circle at 80% 10%, rgba(124,58,237,0.07), transparent 30%),
                  var(--bg);
    }
    .brand { font-weight: 800; letter-spacing: 0.3px; }
    .nav-group { margin-top: 12px; }
    .nav-title { color: var(--muted); font-size: 12px; text-transform: uppercase; margin-bottom: 6px; }
    .nav-link {
      display: block; padding: 10px 12px; border-radius: 10px;
      color: #e5e7eb; text-decoration: none;
    }
    .nav-link:hover { background: rgba(255,255,255,0.04); }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 12px; border-radius: 10px; border: none; cursor: pointer;
      font-weight: 700; color: #0f172a;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }
    .section { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 14px; padding: 16px; margin-bottom: 16px; }
    h2 { margin: 0 0 8px; }
    .muted { color: var(--muted); }
    .list { display: grid; gap: 10px; }
    .item { padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
    .tag { display: inline-flex; padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.1); font-size: 12px; }
    .error { color: #f87171; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; color: #e5e7eb; }
    th, td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align: left; }
    th { cursor: pointer; color: #cbd5e1; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>
  <aside>
    <div class="brand">NoClickOps</div>
      <div class="nav-group">
        <div class="nav-title">Navigation</div>
        <a class="nav-link" href="/dashboard.html">Dashboard</a>
        <a class="nav-link" href="/findings.html">Findings</a>
        <a class="nav-link" href="/scanners.html">Scanners</a>
        <a class="nav-link" href="/docs.html">Docs</a>
        <button class="btn" id="logout-btn">Logout</button>
      </div>
  </aside>
  <main>
    <div class="section" id="findings">
      <h2>Findings</h2>
      <div class="muted" id="findings-meta">Loading findingsâ€¦</div>
      <div style="overflow:auto;">
        <table id="findings-table">
          <thead>
            <tr>
              <th data-sort="ts">Time</th>
              <th data-sort="scanner">Scanner</th>
              <th data-sort="source">Source</th>
              <th data-sort="verb">Verb/Event</th>
              <th data-sort="actor">Actor</th>
              <th data-sort="resource">Resource</th>
              <th data-sort="namespace">Namespace</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="error" id="err" style="display:none;"></div>
  </main>

  <script>
    let token = localStorage.getItem("noclickops_token") || "";
    const err = document.getElementById("err");
    const logoutBtn = document.getElementById("logout-btn");
    const findingsMeta = document.getElementById("findings-meta");
    const findingsTableBody = document.querySelector("#findings-table tbody");
    let currentFindings = [];
    let sortKey = "ts";
    let sortDir = -1; // -1 desc, 1 asc

    function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = "Bearer " + token;
      return fetch(path, { ...opts, headers }).then(async res => {
        const data = await res.json().catch(() => ({}));
        if (res.status === 401) {
          redirectToLogin();
          throw "unauthorized";
        }
        if (!res.ok) throw data.error || res.statusText;
        return data;
      });
    }

    function redirectToLogin() {
      localStorage.removeItem("noclickops_token");
      window.location.href = "/";
    }

    function showError(message) {
      err.style.display = "block";
      err.textContent = message;
    }

    function clearError() {
      err.style.display = "none";
    }

    function renderFindings() {
      const sorted = [...currentFindings].sort((a, b) => {
        const av = a[sortKey] || "";
        const bv = b[sortKey] || "";
        if (av < bv) return -1 * sortDir;
        if (av > bv) return 1 * sortDir;
        return 0;
      });
      findingsTableBody.innerHTML = sorted.map(f => `
        <tr>
          <td class="nowrap">${f.ts}</td>
          <td>${f.scanner}</td>
          <td>${f.source}</td>
          <td>${f.verb || "-"}</td>
          <td>${f.actor || "-"}</td>
          <td>${f.resource || "-"}</td>
          <td>${f.namespace || "-"}</td>
        </tr>
      `).join("");
      findingsMeta.textContent = `${sorted.length} finding(s)`;
    }

    function setupSort() {
      document.querySelectorAll("#findings-table th").forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-sort");
          if (sortKey === key) {
            sortDir = -sortDir;
          } else {
            sortKey = key;
            sortDir = -1;
          }
          renderFindings();
        });
      });
    }

    async function loadFindings() {
      if (!token) return;
      try {
        clearError();
        const list = await api("/v1/scanners");
        // fetch health per scanner to filter active ones? No, just get findings for all.
        // Actually dashboard logic was fetching health first. Let's just fetch findings.
        
        const findings = [];
        await Promise.all(list.map(async s => {
          try {
            const data = await api(`/v1/scanners/${encodeURIComponent(s.name)}/findings`);
            if (Array.isArray(data)) {
              data.forEach(f => findings.push({...f, scanner: s.name}));
            }
          } catch (e) {
            console.warn(`findings for ${s.name} failed`, e);
          }
        }));
        currentFindings = findings;
        renderFindings();
      } catch (e) {
        showError(e);
      }
    }

    logoutBtn.addEventListener("click", redirectToLogin);

    setupSort();
    if (token) loadFindings(); else redirectToLogin();
  </script>
</body>
</html>
