<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoClickOps Findings</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/nav.js"></script>
  <script src="/static/table-utils.js"></script>
</head>

<body>
  <div class="layout-dashboard">
    <aside>
      <div id="nav-container"></div>

      <div style="margin-top:auto;">
        <button id="logout-btn" class="btn btn-secondary" style="width:100%;">Logout</button>
      </div>
    </aside>

    <main>
      <div class="page-header">
        <div>
          <h1 class="page-title">Findings</h1>
          <p class="page-desc" id="findings-meta">Loading findings...</p>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-end;">
          <div class="input-group" style="min-width:140px;">
            <label class="input-label">Trusted</label>
            <select id="trusted-filter">
              <option value="">All</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card" style="padding:0;overflow:hidden;">
        <div class="table-container" style="border:none;border-radius:0;">
          <table id="findings-table">
            <thead>
              <tr>
                <th data-sort="ts" data-filter="ts">Time</th>
                <th data-sort="scanner" data-filter="scanner">Scanner</th>
                <th data-sort="source" data-filter="source">Source</th>
                <th data-sort="verb" data-filter="verb">Verb/Event</th>
                <th data-sort="actor" data-filter="actor">Actor</th>
                <th data-sort="resource" data-filter="resource">Resource</th>
                <th data-sort="namespace" data-filter="namespace">Namespace</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="error" id="err" style="display:none;color:var(--accent-danger);margin-top:20px;"></div>
    </main>
  </div>

  <script>
    mountNav('findings');

    let token = localStorage.getItem("noclickops_token") || "";
    const err = document.getElementById("err");
    const logoutBtn = document.getElementById("logout-btn");
    const findingsMeta = document.getElementById("findings-meta");
    let currentFindings = [];
    let table;

    function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = "Bearer " + token;
      return fetch(path, { ...opts, headers }).then(async res => {
        const data = await res.json().catch(() => ({}));
        if (res.status === 401) {
          redirectToLogin();
          throw "unauthorized";
        }
        if (!res.ok) throw data.error || res.statusText;
        return data;
      });
    }

    function redirectToLogin() {
      localStorage.removeItem("noclickops_token");
      window.location.href = "/";
    }

    function showError(message) {
      err.style.display = "block";
      err.textContent = message;
    }

    function clearError() {
      err.style.display = "none";
    }

    function renderFindings() {
      const trustFilter = document.getElementById("trusted-filter").value;
      const filtered = currentFindings.filter(f => {
        if (!trustFilter) return true;
        const trusted = !!f.trusted;
        return trustFilter === "yes" ? trusted : !trusted;
      });

      // Prepare data for StandardTable
      const tableData = filtered.map(f => ({
        ts: f.ts,
        _render_ts: `<span style="white-space:nowrap;color:var(--text-muted);">${f.ts}</span>`,
        scanner: f.scanner,
        _render_scanner: `<span class="tag">${f.scanner}</span>`,
        source: f.source,
        verb: f.verb || "-",
        _render_verb: `<span style="font-weight:500;color:var(--accent-primary);">${f.verb || "-"}</span>`,
        actor: f.actor || "-",
        resource: f.resource || "-",
        namespace: f.namespace || "-",
      }));

      table.setData(tableData);
      findingsMeta.textContent = `${tableData.length} finding(s)`;
    }

    async function loadFindings() {
      if (!token) return;
      try {
        clearError();
        const list = await api("/v1/scanners");
        const findings = [];
        await Promise.all(list.map(async s => {
          try {
            const data = await api(`/v1/scanners/${encodeURIComponent(s.name)}/findings`);
            if (Array.isArray(data)) {
              data.forEach(f => findings.push({ ...f, scanner: s.name }));
            }
          } catch (e) {
            console.warn(`findings for ${s.name} failed`, e);
          }
        }));
        currentFindings = findings;
        renderFindings();
      } catch (e) {
        showError(e);
      }
    }

    logoutBtn.addEventListener("click", redirectToLogin);
    document.getElementById("trusted-filter").addEventListener("change", renderFindings);

    // Initialize StandardTable
    table = new StandardTable('findings-table', {
      defaultSort: 'ts',
      defaultDir: -1
    });

    if (token) loadFindings(); else redirectToLogin();
  </script>
</body>

</html>
