<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoClickOps Findings</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/nav.js"></script>
</head>

<body>
  <div class="layout-dashboard">
    <aside>
      <div id="nav-container"></div>

      <div style="margin-top:auto;">
        <button id="logout-btn" class="btn btn-secondary" style="width:100%;">Logout</button>
      </div>
    </aside>

    <main>
      <div class="page-header">
        <div>
          <h1 class="page-title">Findings</h1>
          <p class="page-desc" id="findings-meta">Loading findings...</p>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-end;">
          <div class="input-group" style="min-width:140px;">
            <label class="input-label">Trusted</label>
            <select id="trusted-filter">
              <option value="">All</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card" style="padding:0;overflow:hidden;">
        <div class="table-container" style="border:none;border-radius:0;">
          <table id="findings-table">
            <thead>
              <tr>
                <th data-sort="ts" style="cursor:pointer;">Time ↕</th>
                <th data-sort="scanner" style="cursor:pointer;">Scanner ↕</th>
                <th data-sort="source" style="cursor:pointer;">Source ↕</th>
                <th data-sort="verb" style="cursor:pointer;">Verb/Event ↕</th>
                <th data-sort="actor" style="cursor:pointer;">Actor ↕</th>
                <th data-sort="resource" style="cursor:pointer;">Resource ↕</th>
                <th data-sort="namespace" style="cursor:pointer;">Namespace ↕</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="error" id="err" style="display:none;color:var(--accent-danger);margin-top:20px;"></div>
    </main>
  </div>

  <script>
    mountNav('findings');

    let token = localStorage.getItem("noclickops_token") || "";
    const err = document.getElementById("err");
    const logoutBtn = document.getElementById("logout-btn");
    const findingsMeta = document.getElementById("findings-meta");
    const findingsTableBody = document.querySelector("#findings-table tbody");
    let currentFindings = [];
    let sortKey = "ts";
    let sortDir = -1; // -1 desc, 1 asc

    function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = "Bearer " + token;
      return fetch(path, { ...opts, headers }).then(async res => {
        const data = await res.json().catch(() => ({}));
        if (res.status === 401) {
          redirectToLogin();
          throw "unauthorized";
        }
        if (!res.ok) throw data.error || res.statusText;
        return data;
      });
    }

    function redirectToLogin() {
      localStorage.removeItem("noclickops_token");
      window.location.href = "/";
    }

    function showError(message) {
      err.style.display = "block";
      err.textContent = message;
    }

    function clearError() {
      err.style.display = "none";
    }

    function renderFindings() {
      const trustFilter = document.getElementById("trusted-filter").value;
      const filtered = currentFindings.filter(f => {
        if (!trustFilter) return true;
        const trusted = !!f.trusted;
        return trustFilter === "yes" ? trusted : !trusted;
      });

      const sorted = [...filtered].sort((a, b) => {
        const av = a[sortKey] || "";
        const bv = b[sortKey] || "";
        if (av < bv) return -1 * sortDir;
        if (av > bv) return 1 * sortDir;
        return 0;
      });

      if (sorted.length === 0) {
        findingsTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted" style="padding:32px;">No findings found.</td></tr>`;
        findingsMeta.textContent = "0 findings";
        return;
      }

      findingsTableBody.innerHTML = sorted.map(f => `
        <tr>
          <td style="white-space:nowrap;color:var(--text-muted);">${f.ts}</td>
          <td><span class="tag">${f.scanner}</span></td>
          <td>${f.source}</td>
          <td style="font-weight:500;color:var(--accent-primary);">${f.verb || "-"}</td>
          <td>${f.actor || "-"}</td>
          <td>${f.resource || "-"}</td>
          <td>${f.namespace || "-"}</td>
        </tr>
      `).join("");
      findingsMeta.textContent = `${sorted.length} finding(s)`;
    }

    function setupSort() {
      document.querySelectorAll("#findings-table th").forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-sort");
          if (sortKey === key) {
            sortDir = -sortDir;
          } else {
            sortKey = key;
            sortDir = -1;
          }
          renderFindings();
        });
      });
    }

    async function loadFindings() {
      if (!token) return;
      try {
        clearError();
        const list = await api("/v1/scanners");
        const findings = [];
        await Promise.all(list.map(async s => {
          try {
            const data = await api(`/v1/scanners/${encodeURIComponent(s.name)}/findings`);
            if (Array.isArray(data)) {
              data.forEach(f => findings.push({ ...f, scanner: s.name }));
            }
          } catch (e) {
            console.warn(`findings for ${s.name} failed`, e);
          }
        }));
        currentFindings = findings;
        renderFindings();
      } catch (e) {
        showError(e);
      }
    }

    logoutBtn.addEventListener("click", redirectToLogin);

    setupSort();
    document.getElementById("trusted-filter").addEventListener("change", renderFindings);
    if (token) loadFindings(); else redirectToLogin();
  </script>
</body>

</html>
