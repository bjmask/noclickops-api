<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shell Executions | NoClickOps</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/nav.js"></script>
</head>

<body>
    <div class="layout-dashboard">
        <aside>
            <div id="nav-container"></div>
            <div style="margin-top:auto;">
                <button id="logout-btn" class="btn btn-secondary" style="width:100%;">Logout</button>
            </div>
        </aside>
        <main>
            <div class="page-header">
                <div>
                    <h1 class="page-title">üõ°Ô∏è Shell Executions</h1>
                    <p class="page-desc">Real-time detection of suspicious shell activity via eBPF monitoring.</p>
                </div>
                <div style="display:flex;gap:8px;">
                    <select id="severity-filter"
                        style="padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg-main);color:var(--text-main);">
                        <option value="">All Severities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <button class="btn btn-secondary" id="refresh-btn">Refresh</button>
                </div>
            </div>

            <div id="stats" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;">
                <!-- Stats will be populated here -->
            </div>

            <div class="card" style="padding:0;overflow:hidden;">
                <div class="table-container" style="border:none;border-radius:0;">
                    <table id="shells-table" style="width:100%;table-layout:auto;">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Cluster</th>
                                <th>Pod</th>
                                <th>Severity</th>
                                <th>Command</th>
                                <th>PID/PPID</th>
                                <th>Parent</th>
                                <th>Indicators</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="pagination-container" id="pagination" style="margin-top:16px;"></div>
            <div id="err" class="error" style="display:none;color:var(--accent-danger);margin-top:16px;"></div>
        </main>
    </div>

    <script>
        mountNav("security");
        const tbody = document.querySelector("#shells-table tbody");
        const err = document.getElementById("err");
        const refreshBtn = document.getElementById("refresh-btn");
        const severityFilter = document.getElementById("severity-filter");
        const statsDiv = document.getElementById("stats");
        const paginationContainer = document.getElementById("pagination");
        const token = localStorage.getItem("noclickops_token") || "";

        let currentPage = 1;
        let perPage = 50;
        let totalResults = 0;

        function redirectToLogin() {
            localStorage.removeItem("noclickops_token");
            window.location.href = "/";
        }

        async function api(path, opts = {}) {
            const headers = opts.headers || {};
            headers["Content-Type"] = "application/json";
            if (token) headers["Authorization"] = "Bearer " + token;
            const res = await fetch(path, { ...opts, headers });
            let data = {};
            try { data = await res.json(); } catch (_) { }
            if (res.status === 401) { redirectToLogin(); throw "unauthorized"; }
            if (!res.ok) throw data.error || res.statusText;
            return data;
        }

        function showError(msg) {
            err.textContent = msg;
            err.style.display = "block";
        }

        function clearError() { err.style.display = "none"; }

        function getSeverityColor(severity) {
            switch (severity) {
                case "critical": return "var(--accent-danger)";
                case "high": return "#ff6b6b";
                case "medium": return "var(--accent-warning)";
                case "low": return "#4dabf7";
                default: return "var(--text-muted)";
            }
        }

        function renderStats(events) {
            const stats = {
                total: events.length,
                critical: events.filter(e => e.severity === "critical").length,
                high: events.filter(e => e.severity === "high").length,
                medium: events.filter(e => e.severity === "medium").length,
            };

            statsDiv.innerHTML = `
        <div class="card">
          <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:4px;">Total Events</div>
          <div style="font-size:1.8rem;font-weight:700;">${stats.total}</div>
        </div>
        <div class="card">
          <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:4px;">Critical</div>
          <div style="font-size:1.8rem;font-weight:700;color:var(--accent-danger);">${stats.critical}</div>
        </div>
        <div class="card">
          <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:4px;">High</div>
          <div style="font-size:1.8rem;font-weight:700;color:#ff6b6b;">${stats.high}</div>
        </div>
        <div class="card">
          <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:4px;">Medium</div>
          <div style="font-size:1.8rem;font-weight:700;color:var(--accent-warning);">${stats.medium}</div>
        </div>
      `;
        }

        function renderTable(events) {
            tbody.innerHTML = "";

            if (events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:32px;">No shell execution events detected. This is good! üéâ</td></tr>';
                return;
            }

            events.forEach(event => {
                const tr = document.createElement("tr");
                tr.className = "table-row";
                if (event.severity === "critical") tr.classList.add("row-danger");

                // Timestamp
                const tdTime = document.createElement("td");
                tdTime.textContent = new Date(event.timestamp).toLocaleString();
                tdTime.style.fontSize = "0.85rem";
                tr.appendChild(tdTime);

                // Cluster
                const tdCluster = document.createElement("td");
                tdCluster.textContent = event.cluster_name || "-";
                tdCluster.style.fontSize = "0.85rem";
                tdCluster.style.color = event.cluster_name ? "var(--text-main)" : "var(--text-muted)";
                tr.appendChild(tdCluster);

                // Pod
                const tdPod = document.createElement("td");
                if (event.pod_name && event.pod_namespace) {
                    tdPod.textContent = `${event.pod_namespace}:${event.pod_name}`;
                    tdPod.style.fontFamily = "monospace";
                    tdPod.style.fontSize = "0.85rem";
                } else {
                    tdPod.textContent = "-";
                    tdPod.style.color = "var(--text-muted)";
                }
                tr.appendChild(tdPod);

                // Severity
                const tdSeverity = document.createElement("td");
                const severityBadge = document.createElement("span");
                severityBadge.textContent = event.severity.toUpperCase();
                severityBadge.style.padding = "4px 8px";
                severityBadge.style.borderRadius = "4px";
                severityBadge.style.fontSize = "0.75rem";
                severityBadge.style.fontWeight = "600";
                severityBadge.style.color = "#fff";
                severityBadge.style.background = getSeverityColor(event.severity);
                tdSeverity.appendChild(severityBadge);
                tr.appendChild(tdSeverity);

                // Command
                const tdCmd = document.createElement("td");
                tdCmd.textContent = event.comm;
                tdCmd.style.fontFamily = "monospace";
                tdCmd.style.fontWeight = "600";
                tr.appendChild(tdCmd);

                // PID/PPID
                const tdPid = document.createElement("td");
                tdPid.innerHTML = `<span style="font-family:monospace;">${event.pid}</span> / <span style="color:var(--text-muted);font-family:monospace;">${event.ppid}</span>`;
                tdPid.style.fontSize = "0.85rem";
                tr.appendChild(tdPid);

                // Parent
                const tdParent = document.createElement("td");
                tdParent.textContent = event.parent_comm;
                tdParent.style.fontFamily = "monospace";
                tdParent.style.fontSize = "0.85rem";
                tr.appendChild(tdParent);

                // Indicators
                const tdIndicators = document.createElement("td");
                if (event.indicators && event.indicators.length > 0) {
                    event.indicators.forEach(indicator => {
                        const badge = document.createElement("span");
                        badge.textContent = indicator.replace(/_/g, " ");
                        badge.style.display = "inline-block";
                        badge.style.padding = "2px 6px";
                        badge.style.margin = "2px";
                        badge.style.borderRadius = "3px";
                        badge.style.fontSize = "0.7rem";
                        badge.style.background = "var(--accent-primary-alpha)";
                        badge.style.color = "var(--text-main)";
                        tdIndicators.appendChild(badge);
                    });
                } else {
                    tdIndicators.textContent = "-";
                    tdIndicators.style.color = "var(--text-muted)";
                }
                tr.appendChild(tdIndicators);

                // Details button
                const tdDetails = document.createElement("td");
                const detailsBtn = document.createElement("button");
                detailsBtn.textContent = "View";
                detailsBtn.className = "btn btn-secondary";
                detailsBtn.style.fontSize = "0.75rem";
                detailsBtn.style.padding = "4px 12px";
                detailsBtn.onclick = () => showDetails(event);
                tdDetails.appendChild(detailsBtn);
                tr.appendChild(tdDetails);

                tbody.appendChild(tr);
            });
        }

        function showDetails(event) {
            const podInfo = event.pod_name && event.pod_namespace 
                ? `${event.pod_namespace}:${event.pod_name}` 
                : "N/A";
            
            alert(`Shell Execution Details

Command: ${event.comm}
Cmdline: ${event.cmdline || "N/A"}
PID: ${event.pid}
Parent PID: ${event.ppid}
Parent: ${event.parent_comm}
UID: ${event.uid}
GID: ${event.gid}
Severity: ${event.severity}
Indicators: ${event.indicators.join(", ") || "None"}
Remote IP: ${event.remote_ip || "N/A"}
Remote Port: ${event.remote_port || "N/A"}
Agent: ${event.agent_id || "N/A"}
Cluster: ${event.cluster_name || "N/A"}
Pod: ${podInfo}
Timestamp: ${new Date(event.timestamp).toLocaleString()}`);
        }

        function renderPagination() {
            paginationContainer.innerHTML = "";
            const totalPages = Math.ceil(totalResults / perPage);
            if (totalPages <= 1) return;

            const div = document.createElement("div");
            div.style.display = "flex";
            div.style.gap = "8px";
            div.style.alignItems = "center";
            div.style.justifyContent = "center";

            const prevBtn = document.createElement("button");
            prevBtn.textContent = "Previous";
            prevBtn.className = "btn btn-secondary";
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadData();
                }
            };
            div.appendChild(prevBtn);

            const pageInfo = document.createElement("span");
            pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalResults} total)`;
            div.appendChild(pageInfo);

            const nextBtn = document.createElement("button");
            nextBtn.textContent = "Next";
            nextBtn.className = "btn btn-secondary";
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadData();
                }
            };
            div.appendChild(nextBtn);

            paginationContainer.appendChild(div);
        }

        async function loadData() {
            clearError();
            refreshBtn.disabled = true;
            refreshBtn.textContent = "Loading...";

            try {
                const params = new URLSearchParams({
                    page: currentPage.toString(),
                    per_page: perPage.toString(),
                });

                const severityVal = severityFilter.value;
                if (severityVal) {
                    params.append("severity", severityVal);
                }

                const data = await api(`/v1/security/shells?${params}`);
                const events = data.events || [];
                totalResults = data.total || 0;

                renderStats(events);
                renderTable(events);
                renderPagination();
            } catch (e) {
                showError("Failed to load shell executions: " + String(e));
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = "Refresh";
            }
        }

        refreshBtn.addEventListener("click", () => {
            currentPage = 1;
            loadData();
        });

        severityFilter.addEventListener("change", () => {
            currentPage = 1;
            loadData();
        });

        loadData();

        document.getElementById("logout-btn").addEventListener("click", () => {
            localStorage.removeItem("noclickops_token");
            window.location.href = "/";
        });
    </script>
</body>

</html>
